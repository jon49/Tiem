"use strict";var b=bilby,t=b.environment(),f=function(t){var e=t.split("->");return 1===e.length?new Function("x","return ("+e[0].trim()+")"):new Function(e[0].trim(),"return ("+e[1].trim()+")")},isWholeNumber=function(t){return _.isNumber(t)&&t>-1&&Math.floor(t)===t},areUniqueNow=function(t,e){return _.isEmpty(e)?!1:_.isEqual(_.uniq(_.map(e,t)).length,e.length)},areUnique=_.curry(areUniqueNow),toFlatArray=_.compose(_.flatten,_.toArray),complement=function(t){return function(){return!t.apply(null,_.toArray(arguments))}},addRollingArray=function(t,e,o,n){var r=Math.floor;return _.map(t,function(t,i){var a=r(e)<=i&&i<=r(o),s=r(e)===i,u=r(o)===i;return a?s&&u?n*(o-e)+t:s?n*(1+i-e)+t:u?n*(o-i)+t:n+t:t})},fractionalHours=function(t){return t.getHours()+(t.getMinutes()+t.getSeconds()/60)/60},isLikeNumber=function(t){return!isNaN(parseFloat(t))&&isFinite(t)},sum=function(t){return _.reduce(t,function(t,e){return t+(isLikeNumber(e)?+e:0)})},createObject=_.curry(function(t,e){return _.zipObject([t],[e])}),zipObjectT=_.curry(function(t,e,o){return _.zipObject(_.map(o,t),_.map(o,e))}),constants=zipObjectT(_.first,_.compose(_.constant,_.last)),have=_.compose(_.all,_.partialRight(_.map,function(t){return _.has(_.first(t),_.last(t))})),hasAll=_.curry(function(t,e){var o=_.curry(_.has);return _.every(t,o(e))}),isEqual=_.curry(_.isEqual,2),isSomething=complement(_.isEmpty),isSomeString=function(t){return isSomething(t)&&_.isString(t)},mapWith=b.flip(_.curry(_.map)),not=complement(_.identity),hasDeep=b.flip(_.compose(not,_.isEmpty,_.curry(_.findKey,2))),concat=_.curry(function(t,e){return _.isArray(t)?t.concat(e):e.concat(t)}),invokeNow=function(t,e,o){var n="function"==typeof t,r=n?t:null!=e&&e[t],i=_.isArray(o)?o:[];return r?r.apply(e,i):void 0},invoke=_.curry(invokeNow,2),isArrayOf=_.curry(function(t,e){return _.isArray(e)&&_.all(e,t)}),isOptionOf=_.curry(function(t,e){return b.isOption(e)?e.fold(t,!0):!1});t=t.property("isWholeNumber",isWholeNumber).property("areUniqueNow",areUniqueNow).property("areUnique",areUnique).property("toFlatArray",toFlatArray).property("complement",complement).property("addRollingArray",addRollingArray).property("fractionalHours",fractionalHours).property("isLikeNumber",isLikeNumber).property("sum",sum).property("zipObjectT",zipObjectT).property("constants",constants).property("have",have).property("hasAll",hasAll).property("isEqual",isEqual).property("createObject",createObject).property("isSomething",isSomething).property("isSomeString",isSomeString).property("mapWith",mapWith).method("not",_.isBoolean,not).property("hasDeep",hasDeep).property("invoke",invoke).property("isArrayOf",isArrayOf);var makeLenses=_.compose(zipObjectT(_.identity,b.objectLens),_.unique),getNow=function(t,e){return t.run(e||this).getter},get=_.curry(getNow),setNow=function(t,e,o){var n=t.run(e).setter(o);return _.isEqual(n.__proto__,e.__proto__)?n:(n.__proto__=e.__proto__,n)},set=_.curry(setNow),toOption=function(t){var e=t||this;return _.isEmpty(e)||_.isEqual(e.self,window)?b.none:b.some(e)},filterByLensNow=function(t,e,o){var n=o||this;return toOption(_.first(_.filter(n,function(o){return _.isEqual(get(t,o),e)})))},xAddToList=function(t,e,o){var n=o||this;return e.fold(function(e){var o=isEqual(get(t,e));return _.reject(n,function(e){return o(get(t,e))}).concat(e)},n)},overNow=function(t,e,o){var n=o||this;return set(t,n,e.call(null,t.run(n).getter))},over=_.curry(overNow),k=constants([["id"],["hours"],["in"],["out"],["state","clockState"],["day"],["jobList"],["clockedState"],["name"],["clocked"],["comment"],["jobActive"],["jobs"],["jobPlaceHolder","Add Job"],["stampsIn","stamps-in"],["stampsOut","stamps-out"]]);t=t.property("k",k);var jobSettingKeys=[k.id(),k.name(),k.jobActive()],clockInKeys=[k.in()],clockOutKeys=[k.out()],jobKeys=[k.id(),k.comment(),k.hours(),k.state()],listObjects=["list"],L=makeLenses(_.union(jobSettingKeys,clockInKeys,clockOutKeys,jobKeys,listObjects,[k.jobs(),"jobSettings"]));t=t.property("L",L);var JobSetting=b.tagged("JobSetting",jobSettingKeys),ClockedIn=b.tagged("ClockedIn",clockInKeys),ClockedOut=b.tagged("ClockedOut",clockOutKeys),Job=b.tagged("Job",jobKeys),JobSettings=b.tagged("JobSettings",listObjects),Jobs=b.tagged("Jobs",listObjects),getJobByNow=function(t,e,o){var n=get(L.list,o||this);return filterByLensNow(t,e,n)},getJobBy=_.curry(getJobByNow,2),xAddJob=function(t,e){return xAddToList(L.id,t,getNow(L.list,e||this))},replaceList=function(t,e,o){var n=o||this;return n.list=t.call(get(L.list,n),e),n},validJobId=function(t,e){var o=parseInt(e);return isNaN(o)?b.failure(["ID is not a number"]):_.any(t,b.singleton(k.id(),o))?b.success(o):b.failure(["No ID number exists"])},validJobName=function(t,e){var o=t.trim(),n=isEqual(o.toLowerCase());return _.isEmpty(o)?b.failure(["Job name must contain characters"]):_.any(_.pluck(e,"name"),_.compose(n,invoke("toLowerCase")))?b.failure(["Job name already exists"]):b.success(o)},validateSingle=function(t,e){var o=b.curry(b.tagged(t.replace(/^(.){1}/,"$1".toUpperCase()),[t]));return b.Do()(b.Do()(o>e))},validJobName_=function(t,e){var o=get(L.list,e||this);return validateSingle(k.name(),validJobName(t,o))},validId=function(t,e){var o=e||this,n=get(L.list,o);return validateSingle(k.id(),validJobId(n,t))},change=_.curry(function(t,e,o){return o.map(function(o){return set(t,o,e)})}),isClockedIn=hasDeep("in"),clockOut=function(t,e){var o=fractionalHours(get(L.in.compose(L.clockState),t)),n=fractionalHours(e),r=addRollingArray(get(L.hours,t),o,n,1);return _.reduce([[L.clockState,ClockedOut(e)],[L.hours,r]],function(t,e){set(_.first(e),t,_.last(e));return set(_.first(e),t,_.last(e))},t)},updateDate=function(t,e){var o=e||this,n=o.map(function(e){return isClockedIn(e)?clockOut(e,t):set(L.clockState,e,ClockedIn(t))});return n},isCreateJobSetting=function(t,e,o){return isWholeNumber(t)&&_.isString(e)&&_.isBoolean(o)},isCreateJob=function(t,e,o,n,r,i){return isWholeNumber(e)&&_.isString(o)&&isOptionOf(function(t){return _.isArray(t)&&24===t.length},n)&&(_.isEqual(r,k.in())||_.isEqual(r,k.out()))&&_.isDate(i)&&b.isInstanceOf(JobSettings,t)},createJob=function(t,e,o,n,r,i){var a=_.find(t.list,_.compose(isEqual(e),_.partial(getNow,L.id)));if(_.isEmpty(a))return b.error("A new job must be created in the job settings first!");var s=n.getOrElse(_.range(24).map(_.constant(0))),u=_.isEqual(r,k.out())?ClockedOut(i):ClockedIn(i);return Job(e,o,s,u)},createJobFromObject=function(t){var e=_.has(t.clockState,"out")?ClockedOut(new Date(t.clockState.out)):ClockedIn(new Date(t.clockState.in));return Job(parseInt(t.id),t.comment,_(t.hours).map(f("parseFloat(x)")).value(),e)},jobName=_.curry(function(t,e){return t.get(getNow(L.id,e)).fold(get(L.name),"Unknown Name")}),toObject=function(t){return(t||this).getOrElse({})};t=t.property("JobSetting",b.environment().method("create",isCreateJobSetting,_.compose(toOption,JobSetting)).method("create",b.isInstanceOf(JobSetting),toOption).property("newId",f("(new Date()).getTime()")).method("update",_.isString,change(L.name)).method("update",_.isBoolean,change(L.jobActive)).method("toObject",b.isOption,toObject)),t=t.property("Job",b.environment().method("create",isCreateJob,_.compose(toOption,createJob)).method("create",_.isPlainObject,createJobFromObject).method("update",_.isString,change(L.comment)).method("update",_.isDate,updateDate).method("name",function(t,e){return b.isInstanceOf(JobSettings,t)&&b.isInstanceOf(Job,e)},jobName).method("toObject",b.isOption,toObject)),t=t.property("JobSettings",b.environment().method("create",isArrayOf(b.isInstanceOf(JobSetting)),JobSettings).method("valid",_.isNumber,validId).method("valid",_.isString,validJobName_).method("update",isOptionOf(b.isInstanceOf(JobSetting)),function(t){return JobSettings(xAddJob(t,this))}).method("get",isWholeNumber,getJobBy(L.id)).method("get",_.isString,getJobBy(L.name)).property("toArray",_.partial(getNow,L.list))),t=t.property("Jobs",b.environment().method("create",isArrayOf(b.isInstanceOf(Job)),Jobs).method("update",isOptionOf(b.isInstanceOf(Job)),function(t){return Jobs(xAddJob(t,this))}).method("get",isWholeNumber,getJobBy(L.id)).property("toArray",_.partial(getNow,L.list)));var extendObject=function(t,e){_(e).forIn(function(e,o){t.prototype[o]=e})};extendObject(JobSettings,t.JobSettings),extendObject(Jobs,t.Jobs);var app={},getJobs=function(){m.request({method:"GET",url:"/jobs"})();return m.request({method:"GET",url:"/jobs"})},Controller=function(){var e=this;getJobs().then(function(o){var n=_.last(o),r=_.has(n,"jobs")?n.jobs:[],i=_(r).map(function(e){var o=t.Job.create(e);return o}).value(),a=t.Jobs.create(i);e.jobs=a}),this.date=new Date,this.jobSettings=t.JobSettings.create([toObject(t.JobSetting.create(0,"My Job",!0)),toObject(t.JobSetting.create(1,"My cool job",!0))]),this.jobs=[],this.settings={inColor:"DarkSeaGreen",outColor:"FireBrick",inTextColor:"black",outTextColor:"white"}};Controller.prototype.update=function(t){if(_.has(t,"jobs")){var e={date:this.date,jobs:t.jobs.toArray()};$.ajax({type:"POST",url:"/jobs",data:e,dataType:"json",success:function(t){console.log(t)}})}return _.extend(this,t)};var fadeIn=function(t,e){e||$(t).delay(250).fadeIn(1e3)},fadeOut=function(t,e){e||$(t).delay(250).fadeOut(1e3)},$tm=void 0,define$tm=function(t,e){e||($tm=$(t))},moveE=function(t,e){if(!e){var o=$(t),n=29,r=57,i=28,a=18;$tm.delay(2e3).animate({left:r-n-(i-a)},1e3),o.delay(2e3).animate({left:n-r},1e3)}},createNewJob=function(e){return confirm('Create a new job with name: "'+e+'"?')?t.JobSetting.create(t.JobSetting.newId(),e,!0):b.none},addJob=function(e,o){var n=get(L.jobSettings,e),r=n.valid(o).cata({success:function(t){return _.has(t,k.id())?n.get(get(L.id,t)):createNewJob(get(L.name,t))},failure:function(){return b.none}});r.map(function(o){var r=n.update(t.JobSetting.create(o)),i=get(L.jobs,e).update(t.Job.create(r,o.id,"",b.none,k.in(),new Date));e.update(_.zipObject(["jobs","jobSettings"],[i,r]))})},toggleButton=_.curry(function(e){var o=this,n=get(L.jobs,o),r=t.Job.update(new Date,n.get(e));o.update(b.singleton("jobs",n.update(r)))}),selectize_={};selectize_.config=function(t){return function(e,o){var n=$(e);if(!o)var r=_.pluck(t.jobs.toArray(),k.id()),i=_.reject(t.jobSettings.toArray(),function(t){return _.contains(r,get(L.id,t))}),a={persist:!1,selectOnTab:!1,maxItems:1,create:!0,hideSelected:!0,options:i,labelField:k.name(),valueField:k.id(),searchField:k.name(),sortField:k.name(),borderColor:t.settings.inColor,onChange:function(e){m.startComputation(),_.isEmpty(e)||(addJob(t,isLikeNumber(e)?parseInt(e):e),u.removeOption(e),u.refreshItems(),u.showInput()),m.endComputation()}},s=n.selectize(a),u=s[0].selectize}},function(){var e=function(t,e){return t+": "+e+";"},o=function(t){return m("style",[".stamps-in button, .inBackgroundColor {",e("background-color",t.inColor),e("color",t.inTextColor),"}",".stamps-out button {",e("background-color",t.outColor),e("color",t.outTextColor),"}",".inColor {color: ",t.inColor,";}",".selectize-input {border-color: ",t.inColor,";}"].join(""))},n=function(t){return m("header.pure-g",[m("h1.title.pure-u-1-2.inColor",[m("#ti","Ti"),m("#t-m",{config:define$tm},"m"),m("#t-e",{config:moveE},"e"),m("div",{config:fadeOut},"card")]),m(".stamp.date.pure-u-1-2",[m("button.pure-button.options.inBackgroundColor",[m("i.fa.fa-gear")]),m("button.pure-button.inBackgroundColor",t.date.toLocaleDateString(void 0,{year:"numeric",month:"long",day:"numeric"}))])])},r=function(t){return m("#jobs",[m("select",{placeholder:"Enter job name",config:selectize_.config(t)})])},i=_.curry(function(e,o,n){var r=e?{display:"none"}:{},i=e?fadeIn:{},a=o.clockState[isClockedIn(o)?k.in():k.out()];return name=t.Job.name(n.jobSettings,o),m(".stamp.pure-g",{id:o.id,style:r,config:i},[m("button.pure-button.pure-u-14-24.jobButton",{title:name,onclick:toggleButton.bind(n,o.id)},name),m("button.pure-button.pure-u-5-24.time",{title:a},a.toLocaleTimeString()),m("button.pure-button.pure-u-3-24.hours",t.sum(getNow(L.hours,o)).toFixed(2)),m("button.pure-button.pure-u-2-24.notes",{title:o.comment},[m("i.fa.fa-pencil")]),m("button.pure-button.pure-u-1-1.text-left.wrap-word.hidden.comment",o.comment)])}),a=i(!0),s=i(!1),u=_.curry(function(t,e){var o=e.jobs,n=o.toArray(),r=isEqual(_.last(n)),i=_.isEqual(t,".stamps-in")?isClockedIn:_.compose(not,isClockedIn);return m(t,_(n).filter(i).sortBy(_.compose(invoke("toLowerCase"),jobName(e.jobSettings))).map(function(t){return(r(get(L.id,t))?a:s)(t,e)}).value())}),c=u(".stamps-in"),l=u(".stamps-out"),b=function(t){return[o(t.settings),n(t),r(t),c(t),l(t)]};m.module(document.body,{view:b,controller:Controller})}();